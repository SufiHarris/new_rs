#!/bin/bash
# =====================================================
# WORDPRESS MALWARE SCANNER
# Complete security scan for WordPress backup
# Usage: ./wordpress-malware-scan.sh [path-to-backup]
# =====================================================

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Default path
DEFAULT_PATH="/Users/mohammadharissofi/Downloads/public_html_cleaning"

# Use provided path or default
BACKUP_DIR="${1:-$DEFAULT_PATH}"

# Check if directory exists
if [ ! -d "$BACKUP_DIR" ]; then
    echo -e "${RED}Error: Directory not found: $BACKUP_DIR${NC}"
    echo ""
    echo "Usage: $0 [path-to-wordpress-backup]"
    echo "Example: $0 /Users/username/Downloads/public_html_cleaning"
    exit 1
fi

# Navigate to backup directory
cd "$BACKUP_DIR" || exit 1

# Initialize counters
total_critical=0
total_warnings=0
total_info=0

echo -e "${BOLD}=========================================="
echo "   WORDPRESS MALWARE SECURITY SCAN"
echo "==========================================${NC}"
echo ""
echo -e "${BLUE}Scanning:${NC} $BACKUP_DIR"
echo -e "${BLUE}Started:${NC} $(date)"
echo ""

# =====================================================
# CHECK 1: PHP Files in Uploads Directory
# =====================================================
echo -e "${BOLD}[CHECK 1/12] PHP Files in Uploads Directory${NC}"
echo "-------------------------------------------"

php_count=$(find wp-content/uploads -name "*.php" -o -name "*.phtml" -o -name "*.php.*" 2>/dev/null | wc -l | tr -d ' ')

if [ "$php_count" -eq 0 ]; then
    echo -e "${GREEN}‚úÖ PASS: No PHP files in uploads directory${NC}"
else
    echo -e "${RED}‚ùå CRITICAL: Found $php_count PHP files in uploads!${NC}"
    echo ""
    echo "Files found:"
    find wp-content/uploads -name "*.php" -o -name "*.phtml" -o -name "*.php.*" 2>/dev/null | head -20
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  ACTION: Run this to delete them:${NC}"
    echo "find wp-content/uploads -name \"*.php\" -delete"
    ((total_critical++))
fi
echo ""

# =====================================================
# CHECK 2: Known Malware Files
# =====================================================
echo -e "${BOLD}[CHECK 2/12] Known Malware Files${NC}"
echo "-------------------------------------------"

malware_files=(
    "wp-content/db.php:BACKDOOR"
    "wp-content/uploads.php:BACKDOOR"
    "wp-content/cache.php:BACKDOOR"
    "wp-content/class.php:BACKDOOR"
    ".well-known:MALWARE_DIR"
    ".private:MALWARE_DIR"
    "wp-includes/wp-tmp.php:BACKDOOR"
    "wp-content/mu-plugins/network:BACKDOOR_DIR"
    "wp-content/upgrade-temp-backup:SUSPICIOUS"
    "wp-includes/IXR/.private:BACKDOOR_DIR"
)

malware_found=0
for entry in "${malware_files[@]}"; do
    file="${entry%%:*}"
    type="${entry##*:}"
    
    if [ -e "$file" ]; then
        echo -e "${RED}‚ùå FOUND: $file [$type]${NC}"
        ((malware_found++))
    fi
done

if [ $malware_found -eq 0 ]; then
    echo -e "${GREEN}‚úÖ PASS: No known malware files found${NC}"
else
    echo ""
    echo -e "${RED}‚ùå CRITICAL: Found $malware_found known malware files!${NC}"
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  ACTION: Delete these files immediately!${NC}"
    ((total_critical++))
fi
echo ""

# =====================================================
# CHECK 3: Malware Signatures
# =====================================================
echo -e "${BOLD}[CHECK 3/12] Malware Signatures${NC}"
echo "-------------------------------------------"

# Count eval (excluding WordPress core)
eval_count=$(grep -r "eval(" . --include="*.php" 2>/dev/null | \
    grep -v "wp-admin/includes/class-pclzip.php" | \
    grep -v "wp-includes/class-wp-http-encoding.php" | \
    grep -v "wp-includes/Requests" | \
    grep -v "wp-includes/SimplePie" | \
    grep -v "wp-content/plugins/wordfence" | \
    grep -v "wp-content/plugins/elementor" | \
    wc -l | tr -d ' ')

# Count base64_decode (excluding WordPress core)
base64_count=$(grep -r "base64_decode" . --include="*.php" 2>/dev/null | \
    grep -v "wp-admin/includes/class-pclzip.php" | \
    grep -v "wp-includes/class-wp-http-encoding.php" | \
    grep -v "wp-includes/Requests" | \
    grep -v "wp-includes/SimplePie" | \
    grep -v "wp-content/plugins/wordfence" | \
    wc -l | tr -d ' ')

# Count gzinflate (excluding WordPress core)
gzinflate_count=$(grep -r "gzinflate" . --include="*.php" 2>/dev/null | \
    grep -v "wp-admin/includes/class-pclzip.php" | \
    grep -v "wp-includes/class-wp-http-encoding.php" | \
    wc -l | tr -d ' ')

# Count system/exec calls
system_count=$(grep -r "system(\|exec(\|shell_exec(\|passthru(" . --include="*.php" 2>/dev/null | wc -l | tr -d ' ')

echo "Signature counts (excluding WP core & legitimate plugins):"
echo ""
echo "  eval():        $eval_count"
echo "  base64_decode: $base64_count"
echo "  gzinflate:     $gzinflate_count"
echo "  system/exec:   $system_count"
echo ""

# Evaluate risk
risk_level="LOW"
risk_color=$GREEN

if [ "$eval_count" -gt 15 ] || [ "$base64_count" -gt 50 ] || [ "$gzinflate_count" -gt 20 ]; then
    risk_level="HIGH"
    risk_color=$RED
    echo -e "${RED}‚ùå CRITICAL: High malware signature count!${NC}"
    echo "  Safe thresholds: eval<5, base64<30, gzinflate<10"
    ((total_critical++))
elif [ "$eval_count" -gt 5 ] || [ "$base64_count" -gt 30 ] || [ "$gzinflate_count" -gt 10 ]; then
    risk_level="MEDIUM"
    risk_color=$YELLOW
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Moderate suspicious code detected${NC}"
    echo "  Safe thresholds: eval<5, base64<30, gzinflate<10"
    ((total_warnings++))
else
    echo -e "${GREEN}‚úÖ PASS: Signature counts within safe range${NC}"
    echo "  Safe thresholds: eval<5, base64<30, gzinflate<10"
fi

echo -e "Risk Level: ${risk_color}${risk_level}${NC}"
echo ""

# =====================================================
# CHECK 4: Files with Multiple Malware Signatures
# =====================================================
echo -e "${BOLD}[CHECK 4/12] Files with Multiple Malware Signatures${NC}"
echo "-------------------------------------------"

echo "Searching for files with 2+ malware patterns..."
high_risk_files=0

for file in $(find . -name "*.php" -type f 2>/dev/null); do
    score=0
    if grep -q "eval(" "$file" 2>/dev/null; then ((score++)); fi
    if grep -q "base64_decode" "$file" 2>/dev/null; then ((score++)); fi
    if grep -q "gzinflate" "$file" 2>/dev/null; then ((score++)); fi
    if grep -q "system(\|exec(" "$file" 2>/dev/null; then ((score++)); fi
    
    if [ $score -ge 2 ]; then
        # Exclude WordPress core files
        if [[ ! "$file" =~ wp-admin ]] && [[ ! "$file" =~ wp-includes ]]; then
            echo -e "${RED}‚ö†Ô∏è  $file (Score: $score)${NC}"
            ((high_risk_files++))
        fi
    fi
done | head -20

if [ $high_risk_files -eq 0 ]; then
    echo -e "${GREEN}‚úÖ PASS: No high-risk files found${NC}"
else
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Found $high_risk_files files with multiple malware patterns${NC}"
    echo "    Review these files manually"
    ((total_warnings++))
fi
echo ""

# =====================================================
# CHECK 5: wp-config.php Security
# =====================================================
echo -e "${BOLD}[CHECK 5/12] wp-config.php Security${NC}"
echo "-------------------------------------------"

if [ -f "wp-config.php" ]; then
    # Check first line
    first_line=$(head -1 wp-config.php)
    if [ "$first_line" = "<?php" ]; then
        echo -e "${GREEN}‚úÖ File starts correctly with <?php${NC}"
    else
        echo -e "${RED}‚ùå CRITICAL: Code before <?php tag!${NC}"
        echo "First line: $first_line"
        ((total_critical++))
    fi
    
    # Check for suspicious code
    suspicious_config=$(grep -c "eval(\|base64_decode\|gzinflate" wp-config.php)
    if [ "$suspicious_config" -eq 0 ]; then
        echo -e "${GREEN}‚úÖ No suspicious code patterns${NC}"
    else
        echo -e "${RED}‚ùå CRITICAL: Found $suspicious_config suspicious patterns!${NC}"
        ((total_critical++))
    fi
    
    # Check for required constants
    if grep -q "DB_NAME\|DB_USER\|DB_PASSWORD" wp-config.php; then
        echo -e "${GREEN}‚úÖ Database configuration present${NC}"
    else
        echo -e "${RED}‚ùå ERROR: Missing database configuration${NC}"
        ((total_critical++))
    fi
else
    echo -e "${RED}‚ùå CRITICAL: wp-config.php not found!${NC}"
    ((total_critical++))
fi
echo ""

# =====================================================
# CHECK 6: .htaccess Security
# =====================================================
echo -e "${BOLD}[CHECK 6/12] .htaccess Security${NC}"
echo "-------------------------------------------"

if [ -f ".htaccess" ]; then
    htaccess_size=$(wc -c < .htaccess | tr -d ' ')
    echo "File size: $htaccess_size bytes"
    
    # Check for suspicious patterns
    if grep -q "auto_prepend\|auto_append\|php_value.*disable_functions.*''" .htaccess; then
        echo -e "${RED}‚ùå WARNING: Suspicious code patterns found!${NC}"
        ((total_warnings++))
    else
        echo -e "${GREEN}‚úÖ No suspicious patterns${NC}"
    fi
    
    # Check for suspicious redirects
    if grep -q "RewriteCond.*HTTP_REFERER" .htaccess; then
        echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Referrer-based redirects found${NC}"
        echo "   Review manually for malicious redirects"
        ((total_warnings++))
    fi
    
    # Check file size
    if [ "$htaccess_size" -gt 2000 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Large .htaccess file${NC}"
        echo "   Review manually for suspicious content"
        ((total_warnings++))
    else
        echo -e "${GREEN}‚úÖ File size acceptable${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  INFO: No .htaccess file present${NC}"
    echo "   (Will be regenerated by WordPress)"
    ((total_info++))
fi
echo ""

# =====================================================
# CHECK 7: WordPress Core Integrity
# =====================================================
echo -e "${BOLD}[CHECK 7/12] WordPress Core Integrity${NC}"
echo "-------------------------------------------"

core_ok=true

if [ ! -d "wp-admin" ]; then
    echo -e "${RED}‚ùå CRITICAL: wp-admin directory missing!${NC}"
    core_ok=false
    ((total_critical++))
fi

if [ ! -d "wp-includes" ]; then
    echo -e "${RED}‚ùå CRITICAL: wp-includes directory missing!${NC}"
    core_ok=false
    ((total_critical++))
fi

if [ -f "wp-includes/version.php" ]; then
    wp_version=$(grep "wp_version = " wp-includes/version.php 2>/dev/null | cut -d "'" -f 2)
    echo -e "${GREEN}‚úÖ WordPress Version: $wp_version${NC}"
    
    # Check core files
    core_files=("index.php" "wp-load.php" "wp-login.php" "wp-settings.php")
    missing_core=0
    for file in "${core_files[@]}"; do
        if [ ! -f "$file" ]; then
            echo -e "${RED}‚ùå Missing: $file${NC}"
            ((missing_core++))
        fi
    done
    
    if [ $missing_core -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Core files present${NC}"
    else
        echo -e "${RED}‚ùå CRITICAL: $missing_core core files missing${NC}"
        ((total_critical++))
    fi
else
    echo -e "${RED}‚ùå CRITICAL: Cannot determine WordPress version${NC}"
    core_ok=false
    ((total_critical++))
fi
echo ""

# =====================================================
# CHECK 8: Hidden Files
# =====================================================
echo -e "${BOLD}[CHECK 8/12] Hidden PHP Files${NC}"
echo "-------------------------------------------"

hidden_php=$(find . -name ".*\.php" 2>/dev/null | wc -l | tr -d ' ')
if [ "$hidden_php" -eq 0 ]; then
    echo -e "${GREEN}‚úÖ PASS: No hidden PHP files found${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Found $hidden_php hidden PHP files:${NC}"
    find . -name ".*\.php" 2>/dev/null | head -10
    ((total_warnings++))
fi
echo ""

# =====================================================
# CHECK 9: File Permissions
# =====================================================
echo -e "${BOLD}[CHECK 9/12] File Permissions${NC}"
echo "-------------------------------------------"

# Check wp-config.php permissions
if [ -f "wp-config.php" ]; then
    config_perms=$(stat -f "%A" wp-config.php 2>/dev/null || stat -c "%a" wp-config.php 2>/dev/null)
    echo "wp-config.php: $config_perms"
    
    if [ "$config_perms" = "600" ] || [ "$config_perms" = "644" ] || [ "$config_perms" = "400" ]; then
        echo -e "${GREEN}‚úÖ Permissions acceptable${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Unusual permissions${NC}"
        echo "   Recommended: 600 or 644"
        ((total_warnings++))
    fi
fi

# Check for world-writable files
writable=$(find . -type f -perm -002 2>/dev/null | wc -l | tr -d ' ')
if [ "$writable" -eq 0 ]; then
    echo -e "${GREEN}‚úÖ No world-writable files${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: $writable world-writable files found${NC}"
    ((total_warnings++))
fi
echo ""

# =====================================================
# CHECK 10: Plugin Security Scan
# =====================================================
echo -e "${BOLD}[CHECK 10/12] Plugin Security${NC}"
echo "-------------------------------------------"

if [ -d "wp-content/plugins" ]; then
    plugin_count=$(find wp-content/plugins -maxdepth 1 -type d | wc -l | tr -d ' ')
    plugin_count=$((plugin_count - 1)) # Subtract plugins directory itself
    echo "Total plugins: $plugin_count"
    echo ""
    
    suspicious_plugins=0
    for plugin in wp-content/plugins/*/; do
        if [ -d "$plugin" ]; then
            plugin_name=$(basename "$plugin")
            
            # Skip known safe plugins
            if [[ "$plugin_name" == "wordfence" ]] || [[ "$plugin_name" == "elementor" ]] || [[ "$plugin_name" == "woocommerce" ]]; then
                continue
            fi
            
            suspicious=$(grep -r "eval(\|base64_decode\|gzinflate" "$plugin" --include="*.php" 2>/dev/null | wc -l | tr -d ' ')
            
            if [ "$suspicious" -gt 15 ]; then
                echo -e "${YELLOW}‚ö†Ô∏è  $plugin_name: $suspicious suspicious patterns${NC}"
                ((suspicious_plugins++))
            fi
        fi
    done
    
    if [ $suspicious_plugins -eq 0 ]; then
        echo -e "${GREEN}‚úÖ All plugins look clean${NC}"
    else
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  WARNING: $suspicious_plugins plugins need review${NC}"
        ((total_warnings++))
    fi
else
    echo -e "${RED}‚ùå ERROR: Plugins directory not found${NC}"
    ((total_critical++))
fi
echo ""

# =====================================================
# CHECK 11: Theme Security Scan
# =====================================================
echo -e "${BOLD}[CHECK 11/12] Theme Security${NC}"
echo "-------------------------------------------"

if [ -d "wp-content/themes" ]; then
    theme_count=$(find wp-content/themes -maxdepth 1 -type d | wc -l | tr -d ' ')
    theme_count=$((theme_count - 1))
    echo "Total themes: $theme_count"
    echo ""
    
    suspicious_themes=0
    for theme in wp-content/themes/*/; do
        if [ -d "$theme" ]; then
            theme_name=$(basename "$theme")
            suspicious=$(grep -r "eval(\|base64_decode\|gzinflate" "$theme" --include="*.php" 2>/dev/null | wc -l | tr -d ' ')
            
            if [ "$suspicious" -gt 10 ]; then
                echo -e "${YELLOW}‚ö†Ô∏è  $theme_name: $suspicious suspicious patterns${NC}"
                ((suspicious_themes++))
            fi
        fi
    done
    
    if [ $suspicious_themes -eq 0 ]; then
        echo -e "${GREEN}‚úÖ All themes look clean${NC}"
    else
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  WARNING: $suspicious_themes themes need review${NC}"
        ((total_warnings++))
    fi
else
    echo -e "${RED}‚ùå ERROR: Themes directory not found${NC}"
    ((total_critical++))
fi
echo ""

# =====================================================
# CHECK 12: Database-Related Files
# =====================================================
echo -e "${BOLD}[CHECK 12/12] Database Backup Check${NC}"
echo "-------------------------------------------"

sql_files=$(find . -maxdepth 2 -name "*.sql" -o -name "*.sql.gz" 2>/dev/null | wc -l | tr -d ' ')
if [ "$sql_files" -gt 0 ]; then
    echo -e "${GREEN}‚úÖ Found $sql_files database backup file(s)${NC}"
    find . -maxdepth 2 -name "*.sql" -o -name "*.sql.gz" 2>/dev/null | while read sqlfile; do
        size=$(ls -lh "$sqlfile" | awk '{print $5}')
        echo "   $sqlfile ($size)"
    done
else
    echo -e "${YELLOW}‚ö†Ô∏è  INFO: No database backup files found${NC}"
    echo "   Remember to clean and import your database separately"
    ((total_info++))
fi
echo ""

# =====================================================
# FINAL SUMMARY
# =====================================================
echo ""
echo -e "${BOLD}=========================================="
echo "           SCAN SUMMARY                   "
echo "==========================================${NC}"
echo ""

# Display counts
echo -e "${RED}üö® Critical Issues: $total_critical${NC}"
echo -e "${YELLOW}‚ö†Ô∏è  Warnings: $total_warnings${NC}"
echo -e "${BLUE}‚ÑπÔ∏è  Info: $total_info${NC}"
echo ""

# Risk assessment
echo -e "${BOLD}Risk Assessment:${NC} ${risk_color}${risk_level}${NC}"
echo ""

# Key metrics
echo -e "${BOLD}Key Metrics:${NC}"
echo "  PHP in uploads:     $php_count"
echo "  Known malware:      $malware_found"
echo "  eval() calls:       $eval_count"
echo "  base64_decode:      $base64_count"
echo "  gzinflate:          $gzinflate_count"
echo ""

# Final verdict
if [ $total_critical -eq 0 ]; then
    if [ $total_warnings -eq 0 ]; then
        echo -e "${GREEN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        echo -e "${GREEN}${BOLD}     üéâ BACKUP IS CLEAN! üéâ            ${NC}"
        echo -e "${GREEN}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        echo ""
        echo -e "${GREEN}‚úÖ SAFE TO UPLOAD TO PRODUCTION${NC}"
        echo ""
        echo "Recommended next steps:"
        echo "  1. Test site thoroughly on Local by Flywheel"
        echo "  2. Backup production server before upload"
        echo "  3. Upload clean files to production"
        echo "  4. Import cleaned database"
        echo "  5. Install Wordfence on production"
        echo "  6. Run full Wordfence scan"
        echo "  7. Change ALL passwords (WP, FTP, hosting, email)"
        echo "  8. Update all plugins and themes"
        echo "  9. Enable 2FA on WordPress admin"
        echo " 10. Set up regular backups"
    else
        echo -e "${YELLOW}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        echo -e "${YELLOW}${BOLD}  ‚ö†Ô∏è  BACKUP MOSTLY CLEAN - WARNINGS   ${NC}"
        echo -e "${YELLOW}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        echo ""
        echo -e "${GREEN}‚úÖ ACCEPTABLE TO UPLOAD (with caution)${NC}"
        echo ""
        echo "Recommended actions:"
        echo "  1. Review warnings listed above"
        echo "  2. Manually inspect flagged files"
        echo "  3. Test thoroughly on local environment"
        echo "  4. Proceed with upload if tests pass"
        echo "  5. Monitor closely after deployment"
    fi
else
    echo -e "${RED}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo -e "${RED}${BOLD}    ‚ùå BACKUP HAS CRITICAL ISSUES       ${NC}"
    echo -e "${RED}${BOLD}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    echo -e "${RED}üö´ DO NOT UPLOAD TO PRODUCTION!${NC}"
    echo ""
    echo "Required actions before upload:"
    echo "  1. Fix ALL critical issues listed above"
    echo "  2. Delete malware files and PHP from uploads"
    echo "  3. Replace infected core files with fresh WordPress"
    echo "  4. Clean or replace infected themes/plugins"
    echo "  5. Re-run this scan until 0 critical issues"
    echo "  6. Only upload when scan shows clean results"
fi

echo ""
echo -e "${BOLD}=========================================="
echo "Scan completed: $(date)"
echo "==========================================${NC}"
echo ""

# Generate report file
REPORT_FILE="malware-scan-report-$(date +%Y%m%d-%H%M%S).txt"
{
    echo "WORDPRESS MALWARE SCAN REPORT"
    echo "=============================="
    echo ""
    echo "Scan Date: $(date)"
    echo "Directory: $BACKUP_DIR"
    echo ""
    echo "RESULTS:"
    echo "--------"
    echo "Critical Issues: $total_critical"
    echo "Warnings: $total_warnings"
    echo "Info: $total_info"
    echo ""
    echo "METRICS:"
    echo "--------"
    echo "PHP in uploads: $php_count"
    echo "Known malware files: $malware_found"
    echo "eval() calls: $eval_count"
    echo "base64_decode calls: $base64_count"
    echo "gzinflate calls: $gzinflate_count"
    echo "system/exec calls: $system_count"
    echo ""
    echo "Risk Level: $risk_level"
} > "$REPORT_FILE"

echo -e "${BLUE}üìÑ Report saved to: $REPORT_FILE${NC}"
echo ""

# Exit with appropriate code
if [ $total_critical -gt 0 ]; then
    exit 1
else
    exit 0
fi